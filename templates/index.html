<!DOCTYPE html>
<html>
<head>
    <title>Document Intelligence RAG</title>

    <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>

<div class="main">

    <h1>üìÑ Document Intelligence RAG</h1>
    <p class="subtitle">Ask questions about your PDF using AI</p>

    <!-- ================= UPLOAD SECTION ================= -->
    <div class="card">
        <h3>Upload Document</h3>

        <form id="uploadForm" enctype="multipart/form-data">
            <input type="file" name="pdf" id="pdfFile" required>
            <button type="submit">Upload PDF</button>
        </form>

        <!-- Progress bar -->
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <p id="status"></p>
    </div>

    <!-- ================= QUESTION SECTION ================= -->
    <div class="card">
        <h3>Ask a Question</h3>

        <form id="questionForm">
            <input type="text" id="queryInput" placeholder="Type your question..." required>
            <button type="submit">Get Answer</button>
        </form>
    </div>

    <!-- ================= CHAT AREA ================= -->
    <div id="chatArea"></div>

</div>

<!-- ================= JAVASCRIPT ================= -->
<script>
document.addEventListener("DOMContentLoaded", function(){

/* ---------- UPLOAD LOGIC ---------- */
const uploadForm = document.getElementById("uploadForm");
const progressBar = document.getElementById("progressBar");
const progressContainer = document.getElementById("progressContainer");
const statusText = document.getElementById("status");

uploadForm.addEventListener("submit", function(e){
    e.preventDefault();

    const file = document.getElementById("pdfFile").files[0];
    if(!file) return;

    const formData = new FormData();
    formData.append("pdf", file);

    const xhr = new XMLHttpRequest();
    progressContainer.style.display = "block";

    xhr.upload.addEventListener("progress", function(e){
        if(e.lengthComputable){
            let percent = (e.loaded / e.total) * 100;
            progressBar.style.width = percent + "%";
        }
    });

    xhr.onload = function(){
        statusText.innerText = "‚úÖ Upload & Processing Complete!";
    };

    xhr.open("POST", "/upload");
    xhr.send(formData);
});


/* ---------- QUESTION LOGIC ---------- */
const questionForm = document.getElementById("questionForm");
const chatArea = document.getElementById("chatArea");

questionForm.addEventListener("submit", function(e){
    e.preventDefault();

    const queryInput = document.getElementById("queryInput");
    const query = queryInput.value.trim();

    if(!query) return;

    const msgId = "msg-" + Date.now();

    // Show user + loading
    chatArea.innerHTML += `
        <div class="chat">
            <div class="user-msg"><b>You:</b> ${query}</div>
            <div class="bot-msg" id="${msgId}">ü§ñ Thinking...</div>
        </div>
    `;

    // Auto scroll
    window.scrollTo(0, document.body.scrollHeight);

    fetch("/ask", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({query: query})
    })
    .then(res => res.json())
    .then(data => {
        document.getElementById(msgId).innerHTML =
            "<b>AI:</b> " + data.answer;

        window.scrollTo(0, document.body.scrollHeight);
    })
    .catch(err => {
        document.getElementById(msgId).innerHTML =
            "‚ùå Error getting answer.";
    });

    queryInput.value = "";
});

});
</script>

</body>
</html>
